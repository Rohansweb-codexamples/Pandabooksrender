const express = require('express');
const cors = require('cors');
const bodyParser = require('body-parser');

const app = express();

// Middleware
app.use(cors());
app.use(bodyParser.json());

/**
 * DATA STORAGE (In-Memory)
 * Note: Data will reset when the Render service sleeps or restarts.
 * For permanent storage, you would connect MongoDB or PostgreSQL here.
 */
let products = [
    { id: 1, title: "Panda Activity Journal", price: 14.99, description: "Logic puzzles, drawing prompts, and panda fun." },
    { id: 2, title: "Young Writer's Template", price: 19.99, description: "Structured pages to help kids write their first book." }
];

let orders = [];
let users = [];
const team = [
    { name: "Rosie H", role: "Co-Founder" },
    { name: "Emilia B", role: "Lead Designer" },
    { name: "Rohan W", role: "Operations" }
];

// --- 1. AUTHENTICATION ENDPOINTS ---

// Register User
app.post('/register', (req, res) => {
    const { email, password, name } = req.body;
    if (!email || !password) return res.status(400).json({ message: "Missing credentials" });
    
    const existing = users.find(u => u.email === email);
    if (existing) return res.status(400).json({ message: "User already exists" });

    const newUser = { email, password, name, role: 'user' };
    users.push(newUser);
    res.status(201).json({ user: { email, name, role: 'user' } });
});

// Login User
app.post('/login', (req, res) => {
    const { email, password } = req.body;
    const user = users.find(u => u.email === email && u.password === password);
    
    if (user) {
        const { password, ...safeUser } = user; // Don't send password back
        res.json({ user: safeUser });
    } else {
        res.status(401).json({ message: "Invalid email or password" });
    }
});

// --- 2. PRODUCT ENDPOINTS ---

// Get all products
app.get('/products', (req, res) => {
    res.json(products);
});

// Add new product (Admin)
app.post('/products', (req, res) => {
    const { title, price, description } = req.body;
    if (!title || !price) return res.status(400).json({ message: "Title and Price required" });

    const newProduct = {
        id: Date.now(),
        title,
        price: parseFloat(price),
        description: description || "Panda Planet Original"
    };
    products.push(newProduct);
    res.status(201).json(newProduct);
});

// Delete product
app.delete('/products/:id', (req, res) => {
    const id = parseInt(req.params.id);
    products = products.filter(p => p.id !== id);
    res.json({ message: "Product deleted" });
});

// --- 3. ORDER ENDPOINTS ---

// Get all orders (Admin)
app.get('/orders', (req, res) => {
    res.json(orders);
});

// Place a new order
app.post('/orders', (req, res) => {
    const { user, items, total } = req.body;
    if (!user || !items) return res.status(400).json({ message: "Order details missing" });

    const newOrder = {
        id: `ORD-${Date.now()}`,
        user,
        items,
        total: parseFloat(total),
        date: new Date(),
        status: "Confirmed"
    };
    orders.push(newOrder);
    res.status(201).json(newOrder);
});

// --- 4. TEAM ENDPOINTS ---
app.get('/team', (req, res) => {
    res.json(team);
});

// Health check for Render
app.get('/', (req, res) => {
    res.send("Panda Planet API is live and running.");
});

// Start Server
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
    console.log(`Server successfully started on port ${PORT}`);
});
